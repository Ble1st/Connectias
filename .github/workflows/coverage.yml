name: Code Coverage

on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs: 
  coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.13
          cache-read-only: false
      
      - name: Make gradlew executable
        run: chmod +x gradlew
      
      - name: Run tests
        run: ./gradlew test --continue
      
      - name: Generate HTML test report
        run: ./gradlew test --continue || true
      
      - name: Upload test coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 30
      
      - name: Comment coverage summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Try to find test result files
            const testResultsPath = 'app/build/test-results/test';
            let summary = '## Test Coverage Summary\n\n';
            
            try {
              if (fs.existsSync(testResultsPath)) {
                const files = fs.readdirSync(testResultsPath);
                const xmlFiles = files.filter(f => f.endsWith('.xml'));
                
                if (xmlFiles.length > 0) {
                  summary += `âœ… Tests executed: ${xmlFiles.length} test suite(s)\n`;
                  summary += `ğŸ“Š Test results available in artifacts\n\n`;
                } else {
                  summary += 'âš ï¸ No test result files found\n';
                }
              } else {
                summary += 'â„¹ï¸ Test results directory not found\n';
              }
            } catch (error) {
              summary += `â„¹ï¸ Could not read test results: ${error.message}\n`;
            }
            
            summary += '---\n*View detailed reports in the workflow artifacts*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

