name: Android Build Checks

on: 
  push:
    branches: [ main, develop ]
  pull_request: 
    branches: [ main, develop ]

jobs:
  build-check:
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.13
          cache-read-only: false
      
      - name: Make gradlew executable
        run: chmod +x gradlew
      
      - name: Build debug APK
        continue-on-error: false
        run: ./gradlew assembleDebug
      
      - name: Check APK size
        run: |
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "Error: APK not found at $APK_PATH"
            exit 1
          fi
          
          APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH" 2>/dev/null)
          APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
          APK_SIZE_KB=$((APK_SIZE / 1024))
          
          echo "Debug APK size: ${APK_SIZE_MB} MB (${APK_SIZE_KB} KB, ${APK_SIZE} bytes)"
          
          # Warn if APK > 50 MB, fail if > 100 MB
          if [ $APK_SIZE_MB -gt 100 ]; then
            echo "Error: APK size exceeds 100 MB limit"
            exit 1
          elif [ $APK_SIZE_MB -gt 50 ]; then
            echo "Warning: APK size exceeds 50 MB (${APK_SIZE_MB} MB)"
          else
            echo "✅ APK size is within acceptable limits"
          fi
      
      - name: Validate APK integrity
        run: |
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          
          # Validate APK is a valid ZIP file
          if ! unzip -t "$APK_PATH" > /dev/null 2>&1; then
            echo "Error: APK file is not a valid ZIP archive"
            exit 1
          fi
          
          # Check for required APK components
          if ! unzip -l "$APK_PATH" | grep -q "AndroidManifest.xml"; then
            echo "Error: APK is missing AndroidManifest.xml"
            exit 1
          fi
          
          echo "✅ APK integrity validation passed"
      
      - name: Upload debug APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ github.run_number }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

