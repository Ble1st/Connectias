#!/bin/bash
# Projekt-Scanner Script
# Analysiert das Projekt und generiert einen Diagnostik-Report

echo "üîç Connectias Projekt-Scanner"
echo "=================================="
echo ""

# Finde alle HashMap::new() und Vec::new() ohne Capacity
echo "üìä Phase 1: Collection-Allocation-Analyse"
echo "----------------------------------------"
echo ""

echo "Suche nach HashMap::new() ohne Capacity..."
grep -rn "HashMap::new()" crates/connectias-core/src --include="*.rs" | \
    grep -v "//" | \
    grep -v "test" | \
    head -10 | while read line; do
    echo "  ‚ö†Ô∏è  $line"
done

echo ""
echo "Suche nach Vec::new() ohne Capacity..."
grep -rn "Vec::new()" crates/connectias-core/src --include="*.rs" | \
    grep -v "//" | \
    grep -v "test" | \
    head -10 | while read line; do
    echo "  ‚ö†Ô∏è  $line"
done

echo ""
echo "Suche nach potentiellen Race-Conditions (std::sync::Mutex in async)..."
grep -rn "std::sync::Mutex" crates/connectias-core/src --include="*.rs" | \
    grep -v "//" | \
    grep -v "test" | while read line; do
    # Pr√ºfe ob in async Funktion
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    if grep -n "async fn\|tokio::spawn\|\.await" "$file" | grep -q "$line_num"; then
        echo "  üî¥ POTENTIELLES PROBLEM: $line"
    fi
done

echo ""
echo "Suche nach block_on() in async Context..."
grep -rn "block_on\|\.block_on" crates/connectias-core/src --include="*.rs" | \
    grep -v "//" | \
    grep -v "test" | while read line; do
    echo "  ‚ö†Ô∏è  $line"
done

echo ""
echo "‚úÖ Scan abgeschlossen!"
echo ""
echo "üí° N√§chste Schritte:"
echo "   - Verwende hashmap_with_capacity!() f√ºr gefundene HashMap::new()"
echo "   - Verwende vec_with_capacity!() f√ºr gefundene Vec::new()"
echo "   - Ersetze std::sync::Mutex durch tokio::sync::Mutex in async Code"

